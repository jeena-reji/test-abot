name: Cleanup Workflow Runs (Accurate + All Options)

on:
  workflow_dispatch:
    inputs:
      run_status:
        description: 'Which runs do you want to delete?'
        required: true
        type: choice
        options:
          - failure
          - cancelled
          - both
          - all
        default: failure
      page_mode:
        description: 'Choose "range" to specify pages or "all" to delete all available pages'
        required: true
        type: choice
        options:
          - range
          - all
        default: range
      start_page:
        description: 'Start page number (only used if page_mode = range)'
        required: false
        default: '1'
      end_page:
        description: 'End page number (only used if page_mode = range)'
        required: false
        default: '1'

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup Workflow Runs
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_STATUS: ${{ github.event.inputs.run_status }}
          PAGE_MODE: ${{ github.event.inputs.page_mode }}
          START_PAGE: ${{ github.event.inputs.start_page }}
          END_PAGE: ${{ github.event.inputs.end_page }}
          PAGE_SIZE: 10
        run: |
          set +e
          echo "------------------------------------------"
          echo "Repository: $REPO"
          echo "Run type: $RUN_STATUS"
          echo "Page mode: $PAGE_MODE"
          echo "------------------------------------------"

          # Define status filters
          if [ "$RUN_STATUS" = "failure" ]; then
            STATUSES=("failure")
          elif [ "$RUN_STATUS" = "cancelled" ]; then
            STATUSES=("cancelled")
          elif [ "$RUN_STATUS" = "both" ]; then
            STATUSES=("failure" "cancelled")
          else
            STATUSES=("failure" "cancelled" "success" "in_progress" "queued")
          fi

          # Determine all runs (filtered first)
          ALL_RUNS=()
          for STATUS in "${STATUSES[@]}"; do
            echo "Fetching all runs with status: $STATUS ..."
            IDS=$(gh run list --repo "$REPO" --status "$STATUS" --json databaseId -q '.[].databaseId' 2>/dev/null || echo "")
            if [ -n "$IDS" ]; then
              ALL_RUNS+=($IDS)
            fi
          done

          TOTAL_RUNS=${#ALL_RUNS[@]}
          if [ "$TOTAL_RUNS" -eq 0 ]; then
            echo "No runs found for selected status(es)."
            exit 0
          fi

          echo "Total matching runs found: $TOTAL_RUNS"

          # Determine pages
          if [ "$PAGE_MODE" = "all" ]; then
            START_PAGE=1
            END_PAGE=$(( (TOTAL_RUNS + PAGE_SIZE - 1) / PAGE_SIZE ))
          fi

          echo "Processing pages $START_PAGE to $END_PAGE (page size: $PAGE_SIZE)"
          echo "------------------------------------------"

          DELETED=0
          FAILED=0
          PAGE=$START_PAGE
          while [ "$PAGE" -le "$END_PAGE" ]; do
            OFFSET=$(( (PAGE - 1) * PAGE_SIZE ))
            echo ""
            echo "ðŸ”¹ Processing page $PAGE (runs $((OFFSET + 1)) to $((OFFSET + PAGE_SIZE)))..."
            PAGE_RUNS=("${ALL_RUNS[@]:$OFFSET:$PAGE_SIZE}")
            if [ "${#PAGE_RUNS[@]}" -eq 0 ]; then
              echo "  No runs on this page."
              PAGE=$((PAGE + 1))
              continue
            fi
            for RUN_ID in "${PAGE_RUNS[@]}"; do
              echo "Deleting run ID: $RUN_ID ..."
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                -X DELETE "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID")
              if [ "$HTTP_CODE" = "204" ]; then
                echo "  âœ” Deleted $RUN_ID"
                DELETED=$((DELETED + 1))
              else
                echo "  âœ– Failed to delete $RUN_ID (HTTP $HTTP_CODE)"
                FAILED=$((FAILED + 1))
              fi
              sleep 1
            done
            PAGE=$((PAGE + 1))
          done

          echo ""
          echo "------------------------------------------"
          echo "Cleanup Summary:"
          echo "  Successfully deleted: $DELETED"
          echo "  Failed deletions: $FAILED"
          echo "Done âœ…"
