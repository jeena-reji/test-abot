name: Cleanup Workflow Runs (Final Fixed Version)

on:
  workflow_dispatch:
    inputs:
      run_status:
        description: 'Which runs do you want to delete?'
        required: true
        type: choice
        options:
          - failure
          - cancelled
          - both
          - all
        default: failure
      page_mode:
        description: 'Choose "range" to specify pages or "all" to delete all available pages'
        required: true
        type: choice
        options:
          - range
          - all
        default: range
      start_page:
        description: 'Start page number (only used if page_mode = range)'
        required: false
        default: '1'
      end_page:
        description: 'End page number (only used if page_mode = range)'
        required: false
        default: '1'

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup Workflow Runs
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_STATUS: ${{ github.event.inputs.run_status }}
          PAGE_MODE: ${{ github.event.inputs.page_mode }}
          START_PAGE: ${{ github.event.inputs.start_page }}
          END_PAGE: ${{ github.event.inputs.end_page }}
          PAGE_SIZE: 10
        run: |
          set +e
          echo "------------------------------------------"
          echo "Repository: $REPO"
          echo "Run type: $RUN_STATUS"
          echo "Page mode: $PAGE_MODE"
          echo "------------------------------------------"

          DELETED=0
          FAILED=0
          TOTAL=0

          # Define which statuses to include
          if [ "$RUN_STATUS" = "failure" ]; then
            STATUSES=("failure")
          elif [ "$RUN_STATUS" = "cancelled" ]; then
            STATUSES=("cancelled")
          elif [ "$RUN_STATUS" = "both" ]; then
            STATUSES=("failure" "cancelled")
          else
            STATUSES=("failure" "cancelled" "success" "in_progress" "queued")
          fi

          # Detect total pages per selected status
          detect_total_pages_for_status() {
            STATUS="$1"
            PAGE=1
            COUNT=0
            while true; do
              RUNS=$(gh run list --repo "$REPO" --status "$STATUS" --limit "$PAGE_SIZE" --page "$PAGE" --json databaseId -q '.[].databaseId' 2>/dev/null)
              if [ -z "$RUNS" ]; then
                break
              fi
              COUNT=$PAGE
              PAGE=$((PAGE + 1))
            done
            echo "$COUNT"
          }

          TOTAL_PAGES=0
          for STATUS in "${STATUSES[@]}"; do
            PAGES=$(detect_total_pages_for_status "$STATUS")
            if [ "$PAGES" -gt "$TOTAL_PAGES" ]; then
              TOTAL_PAGES=$PAGES
            fi
          done

          echo "Detected total pages for selected status(es): $TOTAL_PAGES"

          # Adjust range if "all" mode
          if [ "$PAGE_MODE" = "all" ]; then
            START_PAGE=1
            END_PAGE=$TOTAL_PAGES
          fi

          # Validate range
          if [ "$END_PAGE" -gt "$TOTAL_PAGES" ]; then
            echo "‚ö†Ô∏è Warning: Selected end page ($END_PAGE) exceeds available pages ($TOTAL_PAGES). Adjusting automatically."
            END_PAGE=$TOTAL_PAGES
          fi

          if [ "$TOTAL_PAGES" -eq 0 ]; then
            echo "‚ùå No workflow runs found for the selected status(es)."
            exit 0
          fi

          echo "Processing pages $START_PAGE to $END_PAGE (page size: $PAGE_SIZE)"
          echo "------------------------------------------"

          for (( PAGE=$START_PAGE; PAGE<=$END_PAGE; PAGE++ )); do
            echo ""
            echo "üîπ Processing page $PAGE..."
            for STATUS in "${STATUSES[@]}"; do
              echo "‚Üí Fetching runs with status: $STATUS"
              RUNS=$(gh run list \
                --repo "$REPO" \
                --status "$STATUS" \
                --limit "$PAGE_SIZE" \
                --page "$PAGE" \
                --json databaseId \
                -q '.[].databaseId' 2>/dev/null)
              if [ -z "$RUNS" ]; then
                echo "  No runs found for $STATUS on this page."
                continue
              fi

              COUNT=$(echo "$RUNS" | wc -w)
              TOTAL=$((TOTAL + COUNT))
              echo "  Found $COUNT run(s) to delete for $STATUS."

              for RUN_ID in $RUNS; do
                echo "  Deleting run ID: $RUN_ID ..."
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -X DELETE "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID")

                if [ "$HTTP_CODE" = "204" ]; then
                  echo "    ‚úî Successfully deleted run $RUN_ID"
                  DELETED=$((DELETED + 1))
                else
                  echo "    ‚úñ Failed to delete run $RUN_ID (HTTP $HTTP_CODE)"
                  FAILED=$((FAILED + 1))
                fi
                sleep 1
              done
            done
          done

          echo ""
          echo "------------------------------------------"
          echo "Cleanup Summary:"
          echo "  Total matching runs: $TOTAL"
          echo "  Successfully deleted: $DELETED"
          echo "  Failed deletions: $FAILED"
          echo "Done ‚úÖ"
