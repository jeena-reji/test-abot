name: Cleanup Workflow Runs (Accurate + Range Support)

on:
  workflow_dispatch:
    inputs:
      run_status:
        description: 'Which runs do you want to delete?'
        required: true
        type: choice
        options:
          - failure
          - cancelled
          - both
          - all
        default: failure
      page_mode:
        description: 'Choose "range" to specify pages or "all" to delete all available pages'
        required: true
        type: choice
        options:
          - range
          - all
        default: range
      start_page:
        description: 'Start page number (only used if page_mode = range)'
        required: false
        default: '1'
      end_page:
        description: 'End page number (only used if page_mode = range)'
        required: false
        default: '1'

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup Workflow Runs
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_STATUS: ${{ github.event.inputs.run_status }}
          PAGE_MODE: ${{ github.event.inputs.page_mode }}
          START_PAGE: ${{ github.event.inputs.start_page }}
          END_PAGE: ${{ github.event.inputs.end_page }}
          PAGE_SIZE: 10
        run: |
          set +e
          echo "------------------------------------------"
          echo "Repository: $REPO"
          echo "Run type: $RUN_STATUS"
          echo "Page mode: $PAGE_MODE"
          echo "------------------------------------------"

          DELETED=0
          FAILED=0
          TOTAL=0

          # Function to detect total pages dynamically
          detect_total_pages() {
            PAGE=1
            while true; do
              RUNS=$(gh run list --repo "$REPO" --limit "$PAGE_SIZE" --page "$PAGE" --json databaseId -q '.[].databaseId' 2>/dev/null)
              if [ -z "$RUNS" ]; then
                break
              fi
              PAGE=$((PAGE + 1))
            done
            echo $((PAGE - 1))
          }

          # Detect total pages if "all" mode
          TOTAL_PAGES=$(detect_total_pages)
          echo "Detected total pages in repo: $TOTAL_PAGES"

          if [ "$PAGE_MODE" = "all" ]; then
            START_PAGE=1
            END_PAGE=$TOTAL_PAGES
          fi

          # Warn if page range is invalid
          if [ "$END_PAGE" -gt "$TOTAL_PAGES" ]; then
            echo "‚ö†Ô∏è Warning: Selected end page ($END_PAGE) exceeds available pages ($TOTAL_PAGES). Adjusting automatically."
            END_PAGE=$TOTAL_PAGES
          fi

          echo "Processing pages $START_PAGE to $END_PAGE (page size: $PAGE_SIZE)"
          echo "------------------------------------------"

          for (( PAGE=$START_PAGE; PAGE<=$END_PAGE; PAGE++ )); do
            echo ""
            echo "üîπ Processing page $PAGE..."
            RUNS=$(gh run list \
              --repo "$REPO" \
              --limit "$PAGE_SIZE" \
              --page "$PAGE" \
              --json databaseId,status \
              -q '.[] | {id: .databaseId, status: .status}' 2>/dev/null)

            if [ -z "$RUNS" ]; then
              echo "  ‚ö†Ô∏è No runs found on this page."
              continue
            fi

            # Filter runs by selected status
            if [ "$RUN_STATUS" = "failure" ]; then
              FILTER=".status == \"failure\""
            elif [ "$RUN_STATUS" = "cancelled" ]; then
              FILTER=".status == \"cancelled\""
            elif [ "$RUN_STATUS" = "both" ]; then
              FILTER="(.status == \"failure\" or .status == \"cancelled\")"
            else
              FILTER="true"
            fi

            MATCHING_RUNS=$(echo "$RUNS" | jq -r "select($FILTER) | .id")

            if [ -z "$MATCHING_RUNS" ]; then
              echo "  No matching runs found on this page for status filter."
              continue
            fi

            COUNT=$(echo "$MATCHING_RUNS" | wc -l)
            TOTAL=$((TOTAL + COUNT))
            echo "  Found $COUNT matching run(s) for deletion."

            for RUN_ID in $MATCHING_RUNS; do
              echo "  Deleting run ID: $RUN_ID ..."
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                -X DELETE "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID")

              if [ "$HTTP_CODE" = "204" ]; then
                echo "    ‚úî Successfully deleted run $RUN_ID"
                DELETED=$((DELETED + 1))
              else
                echo "    ‚úñ Failed to delete run $RUN_ID (HTTP $HTTP_CODE)"
                FAILED=$((FAILED + 1))
              fi
              sleep 1
            done
          done

          echo ""
          echo "------------------------------------------"
          echo "Cleanup Summary:"
          echo "  Total matching runs: $TOTAL"
          echo "  Successfully deleted: $DELETED"
          echo "  Failed deletions: $FAILED"
          echo "Done ‚úÖ"
